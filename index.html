<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë°°ÈªûÂÅ•Ë∫´ ÁÆ°ÁêÜÂæåÂè∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --green: #7ac19a;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --yellow: #ffe08b;
            --blue: #9fcccc;
            --danger: #e05252;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #e2ede6 0%, #daedec 30%, #faece8 60%, #fcf4e3 100%);
            background-attachment: fixed;
            color: #2d3436;
        }

        body::before {
            content: '';
            position: fixed;
            top: -20%;
            right: -10%;
            width: 50vw;
            height: 50vw;
            background: radial-gradient(circle, rgba(122,193,154,0.25) 0%, transparent 60%);
            border-radius: 50%;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -10%;
            left: -15%;
            width: 60vw;
            height: 60vw;
            background: radial-gradient(circle, rgba(159,204,204,0.2) 0%, transparent 60%);
            border-radius: 50%;
            z-index: 0;
        }

        .glass {
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .glass-strong {
            background: rgba(255,255,255,0.72);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* Loading */
        .loading-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #e2ede6 0%, #daedec 30%, #faece8 60%, #fcf4e3 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s, visibility 0.5s;
        }
        .loading-screen.hide { opacity: 0; visibility: hidden; }
        .loading-logo { font-size: 28px; font-weight: 900; color: var(--green-dark); letter-spacing: 4px; margin-bottom: 8px; animation: fadeInUp 0.6s ease; }
        .loading-sub { font-size: 13px; color: #999; letter-spacing: 6px; margin-bottom: 40px; animation: fadeInUp 0.6s ease 0.1s both; }
        .loading-spinner { width: 36px; height: 36px; border: 3px solid rgba(122,193,154,0.2); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-text { margin-top: 20px; font-size: 13px; color: #aaa; animation: fadeInUp 0.6s ease 0.2s both; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        .header { padding: 14px 16px 10px; position: relative; z-index: 1; }
        .header-row { display: flex; align-items: center; gap: 12px; }
        .brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--green), var(--green-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; font-weight: 900; box-shadow: 0 3px 10px rgba(122,193,154,0.3); flex-shrink: 0; }
        .header-info { flex: 1; min-width: 0; }
        .header-info-top { display: flex; align-items: center; gap: 6px; margin-bottom: 1px; }
        .welcome-name { font-size: 17px; font-weight: 800; color: #2d3436; }
        .welcome-hi { font-size: 12px; color: #999; }
        .role-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; background: linear-gradient(135deg, rgba(122,193,154,0.15), rgba(159,204,204,0.15)); color: var(--green-dark); border-radius: 12px; font-size: 11px; font-weight: 600; border: 1px solid rgba(122,193,154,0.15); }
        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .icon-btn { width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.2s; color: #636e72; border: none; }
        .icon-btn:hover { background: rgba(255,255,255,0.8); transform: scale(1.05); }

        /* Main */
        .main { padding: 0 16px 100px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }

        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 0 4px; }
        .section-title { font-size: 13px; font-weight: 600; color: #636e72; letter-spacing: 1px; margin: 0; }
        .section-edit-btn { font-size: 12px; font-weight: 600; color: var(--green); cursor: pointer; padding: 4px 10px; border-radius: 8px; transition: all 0.2s; border: none; background: none; font-family: inherit; }
        .section-edit-btn:hover { background: rgba(122,193,154,0.1); }
        .section-edit-btn.active { color: var(--danger); }

        /* Module Grid */
        .module-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; position: relative; }
        .module-card { border-radius: 18px; padding: 16px 10px; text-align: center; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, opacity 0.2s; position: relative; display: block; text-decoration: none; color: inherit; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        .module-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        .module-card:active:not(.dragging) { transform: scale(0.96); }
        .module-card.developing { opacity: 0.55; }
        .module-icon-wrap { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 8px; pointer-events: none; }
        .module-card[data-color="green"] .module-icon-wrap { background: rgba(122,193,154,0.2); }
        .module-card[data-color="blue"] .module-icon-wrap { background: rgba(159,204,204,0.25); }
        .module-card[data-color="pink"] .module-icon-wrap { background: rgba(242,172,152,0.2); }
        .module-card[data-color="yellow"] .module-icon-wrap { background: rgba(255,224,139,0.3); }
        .module-card[data-color="purple"] .module-icon-wrap { background: rgba(167,139,250,0.2); }
        .module-name { font-size: 13px; font-weight: 600; pointer-events: none; }
        .module-dev-tag { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.08); color: #999; font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 6px; pointer-events: none; }

        .module-card.dragging { opacity: 0.9; transform: scale(1.08) !important; box-shadow: 0 16px 50px rgba(0,0,0,0.18) !important; z-index: 100; transition: none !important; }
        .module-card.drag-over { transform: scale(0.92); opacity: 0.5; }
        .module-grid.edit-mode .module-card { animation: wiggle 0.3s ease infinite alternate; }
        .module-grid.edit-mode .module-card:nth-child(even) { animation-delay: 0.15s; }
        @keyframes wiggle { from { transform: rotate(-1deg); } to { transform: rotate(1deg); } }
        .module-grid.edit-mode .module-card::after { content: '‚†ø'; position: absolute; top: 6px; left: 6px; font-size: 14px; color: rgba(0,0,0,0.2); pointer-events: none; }

        .module-card:nth-child(1) { animation: fadeInUp 0.35s ease 0.12s both; }
        .module-card:nth-child(2) { animation: fadeInUp 0.35s ease 0.17s both; }
        .module-card:nth-child(3) { animation: fadeInUp 0.35s ease 0.22s both; }
        .module-card:nth-child(4) { animation: fadeInUp 0.35s ease 0.27s both; }
        .module-card:nth-child(5) { animation: fadeInUp 0.35s ease 0.32s both; }
        .module-card:nth-child(6) { animation: fadeInUp 0.35s ease 0.37s both; }
        .module-card:nth-child(7) { animation: fadeInUp 0.35s ease 0.42s both; }
        .module-card:nth-child(8) { animation: fadeInUp 0.35s ease 0.47s both; }
        .module-card:nth-child(9) { animation: fadeInUp 0.35s ease 0.52s both; }
        .module-card:nth-child(10) { animation: fadeInUp 0.35s ease 0.57s both; }
        .module-card:nth-child(11) { animation: fadeInUp 0.35s ease 0.62s both; }
        .module-card:nth-child(12) { animation: fadeInUp 0.35s ease 0.67s both; }
        .module-card:nth-child(13) { animation: fadeInUp 0.35s ease 0.72s both; }
        .module-card:nth-child(14) { animation: fadeInUp 0.35s ease 0.77s both; }

        /* Utility */
        .utility-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .utility-btn { flex: 1; min-width: 0; border-radius: 14px; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; font-weight: 600; color: #636e72; cursor: pointer; font-family: inherit; border: none; transition: all 0.2s; }
        .utility-btn:hover { color: var(--green-dark); transform: scale(1.02); }
        .utility-btn:active { transform: scale(0.97); }
        .utility-empty { width: 100%; text-align: center; font-size: 12px; color: #bbb; padding: 10px; }

        .footer { text-align: center; padding: 24px; font-size: 11px; color: #aaa; }

        /* Login */
        .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #e2ede6 0%, #daedec 30%, #faece8 60%, #fcf4e3 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9998; padding: 40px; }
        .login-screen.show { display: flex; }
        .login-card { border-radius: 24px; padding: 36px 28px; width: 100%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); }
        .login-title { text-align: center; font-size: 20px; font-weight: 700; color: var(--green-dark); margin-bottom: 6px; }
        .login-subtitle { text-align: center; font-size: 13px; color: #999; margin-bottom: 28px; }
        .login-input-group { margin-bottom: 16px; }
        .login-label { display: block; font-size: 12px; font-weight: 600; color: #2d3436; margin-bottom: 6px; }
        .login-input { width: 100%; padding: 12px 14px; border: 2px solid rgba(0,0,0,0.06); border-radius: 12px; font-size: 14px; font-family: inherit; transition: border-color 0.2s; outline: none; background: rgba(255,255,255,0.6); }
        .login-input:focus { border-color: var(--green); }
        .login-btn { width: 100%; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; margin-top: 8px; }
        .login-btn-primary { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: white; box-shadow: 0 4px 15px rgba(122,193,154,0.3); }
        .login-btn-primary:hover { box-shadow: 0 6px 20px rgba(122,193,154,0.4); }
        .login-btn-secondary { background: rgba(255,255,255,0.6); color: #636e72; margin-top: 10px; }
        .login-divider { text-align: center; font-size: 12px; color: #bbb; margin: 20px 0; position: relative; }
        .login-divider::before, .login-divider::after { content: ''; position: absolute; top: 50%; width: 30%; height: 1px; background: rgba(0,0,0,0.06); }
        .login-divider::before { left: 0; }
        .login-divider::after { right: 0; }
        .login-error { background: rgba(224,82,82,0.1); color: var(--danger); font-size: 13px; padding: 10px 14px; border-radius: 10px; margin-bottom: 16px; display: none; }
        .login-error.show { display: block; }

        .no-permission { text-align: center; padding: 60px 20px; }
        .no-permission-icon { font-size: 48px; margin-bottom: 16px; }
        .no-permission-title { font-size: 18px; font-weight: 600; color: #2d3436; margin-bottom: 8px; }
        .no-permission-desc { font-size: 13px; color: #636e72; line-height: 1.6; }

        /* Module iframe */
        #modulePage { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; background: #f0f2f5; }
        .module-topbar { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.06); padding: 10px 12px; min-height: 50px; flex-shrink: 0; }
        .module-topbar-left { display: flex; align-items: center; gap: 6px; color: var(--green-dark); font-size: 13px; font-weight: 600; cursor: pointer; padding: 6px 10px; border-radius: 8px; transition: all 0.2s; }
        .module-topbar-left:hover { background: rgba(122,193,154,0.1); }
        .module-topbar-left:active { transform: scale(0.97); }
        .module-back-arrow { font-size: 16px; font-weight: 700; }
        .module-topbar-title { display: flex; align-items: center; gap: 6px; color: #2d3436; font-size: 15px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); }
        .module-topbar-right { display: flex; gap: 6px; }
        .module-topbar-right .icon-btn { width: 32px; height: 32px; font-size: 14px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.04); }
        .module-frame-container { flex: 1; position: relative; overflow: hidden; }
        .module-frame { width: 100%; height: 100%; border: none; background: white; }
        .module-loading { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #e2ede6 0%, #daedec 30%, #faece8 60%, #fcf4e3 100%); z-index: 10; transition: opacity 0.3s; }
        .module-loading.hide { opacity: 0; pointer-events: none; }

        /* Shortcut Picker Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200; display: none; align-items: flex-end; justify-content: center; animation: modalBgIn 0.2s ease; }
        .modal-overlay.show { display: flex; }
        @keyframes modalBgIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-sheet { width: 100%; max-width: 600px; max-height: 80vh; background: white; border-radius: 20px 20px 0 0; padding: 20px 20px 32px; overflow-y: auto; animation: modalSlideUp 0.3s cubic-bezier(0.4,0,0.2,1); }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-handle { width: 36px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 16px; }
        .modal-title { font-size: 16px; font-weight: 700; color: #2d3436; margin-bottom: 4px; }
        .modal-subtitle { font-size: 12px; color: #999; margin-bottom: 20px; }
        .modal-item { display: flex; align-items: center; gap: 14px; padding: 14px 12px; border-radius: 14px; margin-bottom: 6px; cursor: pointer; transition: background 0.15s; }
        .modal-item:hover { background: rgba(0,0,0,0.03); }
        .modal-item:active { background: rgba(0,0,0,0.06); }
        .modal-item-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .modal-item-icon.green { background: rgba(122,193,154,0.2); }
        .modal-item-icon.blue { background: rgba(159,204,204,0.25); }
        .modal-item-icon.pink { background: rgba(242,172,152,0.2); }
        .modal-item-icon.yellow { background: rgba(255,224,139,0.3); }
        .modal-item-icon.purple { background: rgba(167,139,250,0.2); }
        .modal-item-info { flex: 1; }
        .modal-item-name { font-size: 14px; font-weight: 600; }
        .modal-item-desc { font-size: 11px; color: #999; }
        .modal-item-check { width: 28px; height: 28px; border-radius: 8px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; transition: all 0.2s; }
        .modal-item.selected .modal-item-check { background: var(--green); border-color: var(--green); color: white; }
        .modal-actions { display: flex; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.06); }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .modal-btn-cancel { background: #f0f2f5; color: #636e72; }
        .modal-btn-save { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: white; }

        /* Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(45,52,54,0.9); backdrop-filter: blur(10px); color: white; padding: 12px 24px; border-radius: 14px; font-size: 13px; font-weight: 500; z-index: 10000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.15); white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Developing modal */
        .dev-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200; display: none; align-items: center; justify-content: center; }
        .dev-modal-overlay.show { display: flex; }
        .dev-modal { background: white; border-radius: 20px; padding: 32px 28px; text-align: center; max-width: 320px; width: 90%; animation: fadeInUp 0.3s ease; }
        .dev-modal-icon { font-size: 48px; margin-bottom: 12px; }
        .dev-modal-title { font-size: 16px; font-weight: 700; color: #2d3436; margin-bottom: 6px; }
        .dev-modal-desc { font-size: 13px; color: #999; margin-bottom: 20px; line-height: 1.5; }
        .dev-modal-btn { padding: 12px 32px; border: none; border-radius: 12px; background: var(--green); color: white; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }

        @media (max-width: 360px) {
            .module-grid { gap: 6px; }
            .module-card { padding: 12px 6px; }
            .module-icon-wrap { width: 42px; height: 42px; font-size: 20px; }
            .module-name { font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">Ë°°ÈªûÂÅ•Ë∫´</div>
        <div class="loading-sub">BALANCE POINT</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Á≥ªÁµ±ËºâÂÖ•‰∏≠...</div>
    </div>

    <div class="login-screen" id="loginScreen">
        <div class="login-card glass-strong">
            <div class="login-title">üèãÔ∏è Ë°°ÈªûÂÅ•Ë∫´</div>
            <div class="login-subtitle">ÁÆ°ÁêÜÂæåÂè∞ÁôªÂÖ•</div>
            <div class="login-error" id="loginError"></div>
            <div class="login-input-group">
                <label class="login-label">Â∏≥Ëôü</label>
                <input type="text" class="login-input" id="loginUsername" placeholder="Ë´ãËº∏ÂÖ•Â∏≥Ëôü" autocomplete="username">
            </div>
            <div class="login-input-group">
                <label class="login-label">ÂØÜÁ¢º</label>
                <input type="password" class="login-input" id="loginPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" autocomplete="current-password">
            </div>
            <button class="login-btn login-btn-primary" onclick="handleManualLogin()">ÁôªÂÖ•</button>
            <div class="login-divider">Êàñ</div>
            <button class="login-btn login-btn-secondary" onclick="retryLiffLogin()">‰ΩøÁî® LINE ÁôªÂÖ•</button>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="header-row">
                <div class="brand-icon">Ë°°</div>
                <div class="header-info">
                    <div class="header-info-top">
                        <span class="welcome-name" id="userName">ÁÆ°ÁêÜÂì°</span>
                        <span class="welcome-hi" id="greetingText">Êó©ÂÆâ ‚òÄÔ∏è</span>
                    </div>
                    <div class="role-tag"><span>üîë</span><span id="userRoleText">Ë∂ÖÁ¥öÁÆ°ÁêÜÂì°</span></div>
                </div>
                <div class="header-actions">
                    <div class="icon-btn glass" onclick="refreshData()" title="ÈáçÊñ∞Êï¥ÁêÜ">üîÑ</div>
                    <div class="icon-btn glass" onclick="handleLogout()" title="ÁôªÂá∫">‚èèÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="section-header" style="margin-top: 6px;">
                <div class="section-title">ÂäüËÉΩÊ®°ÁµÑ</div>
                <button class="section-edit-btn" id="editModuleBtn" onclick="toggleEditMode()">Á∑®ËºØÊéíÂ∫è</button>
            </div>
            <div class="module-grid" id="moduleGrid"></div>

            <div class="section-header">
                <div class="section-title">Âø´Êç∑Â∑•ÂÖ∑</div>
                <button class="section-edit-btn" onclick="openShortcutPicker()">Ëá™Ë®Ç</button>
            </div>
            <div class="utility-row" id="utilityRow"></div>

            <div class="footer">Ë°°ÈªûÂÅ•Â∫∑ ¬© 2025-2026<br><span style="font-size:10px;color:#ccc;">v1.2.0</span></div>
        </div>

        <div id="modulePage" style="display:none;">
            <div class="module-topbar">
                <div class="module-topbar-left" onclick="backToHome()">
                    <span class="module-back-arrow">‚Üê</span><span>ËøîÂõûÈ¶ñÈ†Å</span>
                </div>
                <div class="module-topbar-title">
                    <span id="moduleIcon"></span><span id="moduleTitle"></span>
                </div>
                <div class="module-topbar-right">
                    <div class="icon-btn" onclick="refreshModule()" title="ÈáçÊñ∞Êï¥ÁêÜ">üîÑ</div>
                    <div class="icon-btn" onclick="openModuleNewTab()" title="Êñ∞ÂàÜÈ†ÅÈñãÂïü">‚ÜóÔ∏è</div>
                </div>
            </div>
            <div class="module-frame-container">
                <div class="module-loading" id="moduleLoading">
                    <div class="loading-spinner" style="width:28px;height:28px;border-width:2.5px;"></div>
                    <span style="margin-top:12px;font-size:13px;color:#999;">ËºâÂÖ•‰∏≠...</span>
                </div>
                <iframe id="moduleFrame" class="module-frame" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Shortcut Picker -->
    <div class="modal-overlay" id="shortcutModal">
        <div class="modal-sheet">
            <div class="modal-handle"></div>
            <div class="modal-title">‚ö° Ëá™Ë®ÇÂø´Êç∑Â∑•ÂÖ∑</div>
            <div class="modal-subtitle">ÈÅ∏ÊìáË¶ÅÈ°ØÁ§∫Âú®Âø´Êç∑ÂçÄÁöÑÊ®°ÁµÑÔºàÊúÄÂ§ö 4 ÂÄãÔºâ</div>
            <div id="shortcutList"></div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeShortcutPicker()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-save" onclick="saveShortcuts()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- Developing Modal -->
    <div class="dev-modal-overlay" id="devModal">
        <div class="dev-modal">
            <div class="dev-modal-icon">üöß</div>
            <div class="dev-modal-title">ÂäüËÉΩÈñãÁôº‰∏≠</div>
            <div class="dev-modal-desc">Ê≠§Ê®°ÁµÑÊ≠£Âú®ÈñãÁôº‰∏≠Ôºå<br>È†êË®àËøëÊúü‰∏äÁ∑öÔºåÊï¨Ë´ãÊúüÂæÖÔºÅ</div>
            <button class="dev-modal-btn" onclick="closeDevModal()">Áü•ÈÅì‰∫Ü</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    const CONFIG = {
        LIFF_ID: '2007947083-YCFwz7Uk',
        WEBHOOK_URL: 'https://hook.us2.make.com/xufy9muvlrjioip4xyqa313pg4fjrwol',
        BASE_URL: 'https://oxencust.github.io/admin-portal/',
        VERSION: '1.2.0'
    };

    // ====================================================================
    //  ALL MODULES ‚Äî roles ÊéßÂà∂Ë™∞ÁúãÂæóÂà∞
    // ====================================================================
    const MODULES = [
        // ‚îÄ‚îÄ‚îÄ ÁÆ°ÁêÜÊ®°ÁµÑ ‚îÄ‚îÄ‚îÄ
        { id:'member', icon:'üë§', name:'Â≠∏Âì°ÁÆ°ÁêÜ', desc:'ÊúÉÂì°Ë≥áÊñô„ÄÅÁãÄÊÖãÁÆ°ÁêÜ',
          url:'member.html', color:'green',
          roles:['super_admin','admin','staff'] },

        { id:'coach', icon:'üë®‚Äçüè´', name:'ÊïôÁ∑¥ÁÆ°ÁêÜ', desc:'ÊïôÁ∑¥ÂêçÂñÆ„ÄÅÊ¨äÈôêË®≠ÂÆö',
          url:'coach-manage.html', color:'blue',
          roles:['super_admin','admin','staff'] },

        { id:'substitute', icon:'üìã', name:'‰ª£Ë™≤ÁÆ°ÁêÜ', desc:'‰ª£Ë™≤Ë´ãÊ±Ç„ÄÅËÅäÂ§©ÂçîË™ø',
          url:'admin.html', color:'pink',
          roles:['super_admin','admin','coach','staff'] },

        { id:'schedule', icon:'üóìÔ∏è', name:'Ë°åÊîøÊéíÁè≠', desc:'ÊéíÁè≠ÁÆ°ÁêÜ„ÄÅÁè≠Ë°®Ë®≠ÂÆö',
          url:'https://oxencust.github.io/staff-schedule/', color:'yellow',
          roles:['super_admin','admin'] },

        { id:'punch', icon:'‚è∞', name:'‰∏ä‰∏ãÁè≠ÊâìÂç°', desc:'ÊâìÂç°Á¥ÄÈåÑ„ÄÅÂá∫Âã§Áµ±Ë®à',
          url:'punch.html', color:'green',
          roles:['super_admin','admin','staff'] },

        { id:'report', icon:'üìä', name:'Â†±Ë°®Áµ±Ë®à', desc:'ÁáüÈÅãÊï∏Êìö„ÄÅÂàÜÊûêÂ†±Ë°®',
          url:'report.html', color:'blue',
          roles:['super_admin','admin'] },

        { id:'settings', icon:'üîê', name:'Á≥ªÁµ±Ë®≠ÂÆö', desc:'Ê¨äÈôêÁÆ°ÁêÜ„ÄÅÁ≥ªÁµ±ÈÖçÁΩÆ',
          url:'settings.html', color:'pink',
          roles:['super_admin'] },

        // ‚îÄ‚îÄ‚îÄ Ë°åÊîøÂ∑•ÂÖ∑ ‚îÄ‚îÄ‚îÄ
        { id:'moti-booking', icon:'üìù', name:'È†êÂ°´MotiÂêçÂñÆ', desc:'MotiÈ†êÁ¥ÑÂêçÂñÆÈ†êÂ°´',
          url:'https://oxencust.github.io/moti-bookinglist/', color:'blue',
          roles:['super_admin','admin','staff'] },

        { id:'leave-manage', icon:'üè•', name:'Â≠∏Âì°Ë´ãÂÅáÁÆ°ÁêÜ', desc:'Â≠∏Âì°Ë´ãÂÅáÁî≥Ë´ãËôïÁêÜ',
          url:'', color:'pink',
          roles:['super_admin','admin','staff'], developing: true },

        { id:'personal-schedule', icon:'üìÖ', name:'ÂÄã‰∫∫ÊéíÁè≠', desc:'Êü•ÁúãÊàëÁöÑÊéíÁè≠',
          url:'https://oxencust.github.io/staff-schedule/personal', color:'yellow',
          roles:['super_admin','admin','staff'] },

        // ‚îÄ‚îÄ‚îÄ ÊïôÁ∑¥Â∑•ÂÖ∑ ‚îÄ‚îÄ‚îÄ
        { id:'trial-schedule', icon:'üóìÔ∏è', name:'È´îÈ©óÊéíÁ®ã', desc:'È´îÈ©óË™≤ÂèØÈ†êÁ¥ÑÊôÇÊÆµ',
          url:'https://experience3.zeabur.app/', color:'yellow',
          roles:['super_admin','admin','coach'],
          customParams: { teacher: '{name}', type: '' } },

        { id:'trial-feedback', icon:'üí¨', name:'È´îÈ©óË™≤ÂõûÂ†±', desc:'È´îÈ©óË™≤ÂæåÂõûÂ†±Â°´ÂØ´',
          url:'https://feedback-form.zeabur.app', color:'green',
          roles:['super_admin','admin','coach'] },

        { id:'class-record', icon:'üìã', name:'Ë™≤Ë°®Á¥ÄÈåÑ', desc:'Ë™≤Â†ÇÁ¥ÄÈåÑÊü•Ë©¢',
          url:'https://classrecord.zeabur.app', color:'blue',
          roles:['super_admin','admin','coach'] },

        // ‚îÄ‚îÄ‚îÄ ÂàÜÊûêÂ∏´ ‚îÄ‚îÄ‚îÄ
        { id:'moti-analyze', icon:'üî¨', name:'MotiÊ™¢Ê∏¨Á¥ÄÈåÑ', desc:'MotiÊ™¢Ê∏¨Á¥ÄÈåÑË°®',
          url:'https://analyze-form.zeabur.app', color:'purple',
          roles:['super_admin','admin','analyst'] },
    ];

    // Âø´Êç∑Â∑•ÂÖ∑ÂÄôÈÅ∏ÔºàÊéíÈô§ÈñãÁôº‰∏≠Ôºâ
    const ALL_SHORTCUTS = MODULES.filter(m => !m.developing).map(m => ({ ...m, id: 'sc_' + m.id }));

    // ÂêÑËßíËâ≤È†êË®≠Âø´Êç∑
    const DEFAULT_SHORTCUTS_BY_ROLE = {
        super_admin: ['sc_personal-schedule', 'sc_moti-booking'],
        admin: ['sc_personal-schedule', 'sc_moti-booking'],
        coach: ['sc_trial-schedule', 'sc_class-record'],
        staff: ['sc_personal-schedule', 'sc_punch'],
        analyst: ['sc_moti-analyze']
    };

    let currentUser = null, authToken = null, isEditMode = false;

    // ====================================================================
    //  STORAGE
    // ====================================================================
    function getStorageKey(k) { return `portal_${currentUser?.lineUid||'default'}_${k}`; }
    function loadModuleOrder() { try { const s=localStorage.getItem(getStorageKey('module_order')); return s?JSON.parse(s):null; } catch{return null;} }
    function saveModuleOrder(o) { try{localStorage.setItem(getStorageKey('module_order'),JSON.stringify(o));}catch{} }
    function loadShortcutIds() { try { const s=localStorage.getItem(getStorageKey('shortcuts')); return s?JSON.parse(s):null; } catch{return null;} }
    function saveShortcutIds(ids) { try{localStorage.setItem(getStorageKey('shortcuts'),JSON.stringify(ids));}catch{} }

    // ====================================================================
    //  INIT
    // ====================================================================
    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (liff.isLoggedIn()) {
                const p = await liff.getProfile();
                await authenticateUser(p.userId, p.displayName, p.pictureUrl, 'liff');
            } else if (liff.isInClient()) { liff.login(); }
            else { showLoginScreen(); }
        } catch(e) { console.error('LIFF init error:', e); showLoginScreen(); }
    }

    // ====================================================================
    //  AUTH
    // ====================================================================
    async function authenticateUser(lineUid, displayName, pictureUrl, method) {
        try {
            updateLoadingText('È©óË≠âË∫´‰ªΩ‰∏≠...');
            const r = await fetch(CONFIG.WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ module:'auth', action:'login', data:{lineUid,displayName,method} }) });
            const result = await r.json();
            if (result.success && result.user) {
                currentUser = { id:result.user.id, name:result.user.name||displayName, lineUid, role:result.user.role, permissions:result.user.permissions||[], pictureUrl };
                authToken = result.token || generateToken(lineUid);
                updateLoadingText('ËºâÂÖ•Ê®°ÁµÑ‰∏≠...');
                renderApp(); hideLoading();
            } else { showNoPermission(); }
        } catch(e) {
            if (CONFIG.WEBHOOK_URL.includes('YOUR_')) {
                currentUser = { id:1, name:displayName||'ÈñãÁôºÊ®°Âºè', lineUid:lineUid||'dev_user', role:'super_admin', permissions:['all'], pictureUrl };
                authToken = generateToken('dev'); renderApp(); hideLoading();
                showToast('‚ö†Ô∏è ÈñãÁôºÊ®°ÂºèÔºàË´ãË®≠ÂÆö WebhookÔºâ');
            } else { showLoginScreen(); showToast('‚ùå ÈÄ£Á∑öÂ§±Êïó'); }
        }
    }

    async function handleManualLogin() {
        const u = document.getElementById('loginUsername').value.trim();
        const p = document.getElementById('loginPassword').value.trim();
        if (!u||!p) { showLoginError('Ë´ãËº∏ÂÖ•Â∏≥ËôüÂíåÂØÜÁ¢º'); return; }
        try {
            const r = await fetch(CONFIG.WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ module:'auth', action:'manualLogin', data:{username:u,password:p} }) });
            const result = await r.json();
            if (result.success && result.user) {
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('loadingScreen').classList.remove('hide');
                await authenticateUser(result.user.lineUid, result.user.name, null, 'manual');
            } else { showLoginError('Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§'); }
        } catch(e) {
            if (CONFIG.WEBHOOK_URL.includes('YOUR_')) {
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('loadingScreen').classList.remove('hide');
                currentUser = { id:1, name:u, lineUid:'manual_'+u, role:'super_admin', permissions:['all'] };
                authToken = generateToken(u); renderApp(); hideLoading(); showToast('‚ö†Ô∏è ÈñãÁôºÊ®°ÂºèÁôªÂÖ•');
            } else { showLoginError('ÈÄ£Á∑öÂ§±Êïó'); }
        }
    }

    function retryLiffLogin() { liff.isInClient() ? liff.login() : liff.login({ redirectUri: window.location.href }); }
    function handleLogout() { if(confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')){ currentUser=null; authToken=null; if(liff.isLoggedIn()) liff.logout(); window.location.reload(); } }
    function generateToken(s) { return btoa(`${s}:${Date.now()}:${Math.random().toString(36).substring(2,10)}`); }

    // ====================================================================
    //  RENDER
    // ====================================================================
    function renderApp() {
        if (!currentUser) return;
        document.getElementById('mainApp').style.display = 'block';
        setGreeting();
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userRoleText').textContent = getRoleDisplay(currentUser.role);
        renderModules();
        renderUtilities();
    }

    function getOrderedModules() {
        const visible = MODULES.filter(m => hasModuleAccess(m));
        const savedOrder = loadModuleOrder();
        if (!savedOrder) return visible;
        const ordered = [];
        savedOrder.forEach(id => { const mod = visible.find(m => m.id === id); if (mod) ordered.push(mod); });
        visible.forEach(m => { if (!ordered.includes(m)) ordered.push(m); });
        return ordered;
    }

    function renderModules() {
        const grid = document.getElementById('moduleGrid');
        grid.innerHTML = '';
        const ordered = getOrderedModules();

        ordered.forEach(mod => {
            const card = document.createElement('a');
            card.className = 'module-card glass-strong' + (mod.developing ? ' developing' : '');
            card.dataset.color = mod.color;
            card.dataset.id = mod.id;
            card.href = 'javascript:void(0)';
            card.onclick = () => {
                if (isEditMode) return;
                if (mod.developing) { showDevModal(); return; }
                navigateToModule(mod);
            };

            const badgeHtml = mod.developing ? '<div class="module-dev-tag">ÈñãÁôº‰∏≠</div>' : '';
            card.innerHTML = `${badgeHtml}<div class="module-icon-wrap">${mod.icon}</div><div class="module-name">${mod.name}</div>`;
            grid.appendChild(card);
        });

        if (isEditMode) { grid.classList.add('edit-mode'); initDragAndDrop(); }
    }

    function renderUtilities() {
        const row = document.getElementById('utilityRow');
        row.innerHTML = '';
        const defaultIds = DEFAULT_SHORTCUTS_BY_ROLE[currentUser.role] || [];
        const savedIds = loadShortcutIds() || defaultIds;
        const available = ALL_SHORTCUTS.filter(s => s.roles.includes(currentUser.role));
        const active = savedIds.map(id => available.find(s => s.id === id)).filter(Boolean);

        if (active.length === 0) {
            row.innerHTML = '<div class="utility-empty">ÈªûÊìä„ÄåËá™Ë®Ç„ÄçÊ∑ªÂä†Âø´Êç∑Â∑•ÂÖ∑</div>';
            return;
        }
        active.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'utility-btn glass';
            btn.onclick = () => navigateToModule(item);
            btn.innerHTML = `${item.icon} ${item.name}`;
            row.appendChild(btn);
        });
    }

    // ====================================================================
    //  DRAG & DROP
    // ====================================================================
    let dragState = null;

    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('editModuleBtn');
        const grid = document.getElementById('moduleGrid');
        if (isEditMode) {
            btn.textContent = 'ÂÆåÊàê'; btn.classList.add('active');
            grid.classList.add('edit-mode'); initDragAndDrop();
            showToast('üîÄ ÊãñÂãïÊ®°ÁµÑÂèØË™øÊï¥È†ÜÂ∫è');
        } else {
            btn.textContent = 'Á∑®ËºØÊéíÂ∫è'; btn.classList.remove('active');
            grid.classList.remove('edit-mode'); cleanupDrag();
            const order = Array.from(grid.querySelectorAll('.module-card')).map(c => c.dataset.id);
            saveModuleOrder(order); showToast('‚úÖ ÊéíÂ∫èÂ∑≤ÂÑ≤Â≠ò');
        }
    }

    function initDragAndDrop() {
        const cards = document.getElementById('moduleGrid').querySelectorAll('.module-card');
        cards.forEach(card => {
            card.addEventListener('touchstart', onDragStart, { passive: false });
            card.addEventListener('touchmove', onDragMove, { passive: false });
            card.addEventListener('touchend', onDragEnd);
            card.addEventListener('mousedown', onDragStart);
        });
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
    }
    function cleanupDrag() { document.removeEventListener('mousemove', onDragMove); document.removeEventListener('mouseup', onDragEnd); }

    function onDragStart(e) {
        if (!isEditMode) return; e.preventDefault();
        const card = e.currentTarget, touch = e.touches ? e.touches[0] : e, rect = card.getBoundingClientRect();
        dragState = { el:card, offsetX:touch.clientX-rect.left, offsetY:touch.clientY-rect.top, origRect:rect, moved:false };
        dragState.timer = setTimeout(() => {
            if (!dragState) return;
            card.classList.add('dragging');
            card.style.position='fixed'; card.style.width=rect.width+'px';
            card.style.left=(touch.clientX-dragState.offsetX)+'px'; card.style.top=(touch.clientY-dragState.offsetY)+'px';
            card.style.zIndex='100'; dragState.moved=true;
            const ph=document.createElement('div'); ph.className='module-card glass-strong'; ph.style.opacity='0.2'; ph.style.minHeight=rect.height+'px'; ph.dataset.placeholder='true';
            card.parentNode.insertBefore(ph,card); dragState.placeholder=ph;
        }, 150);
    }

    function onDragMove(e) {
        if (!dragState||!dragState.moved) return; e.preventDefault();
        const touch=e.touches?e.touches[0]:e, card=dragState.el;
        card.style.left=(touch.clientX-dragState.offsetX)+'px'; card.style.top=(touch.clientY-dragState.offsetY)+'px';
        card.style.pointerEvents='none';
        const under=document.elementFromPoint(touch.clientX,touch.clientY);
        card.style.pointerEvents='';
        const target=under?.closest('.module-card:not(.dragging):not([data-placeholder])');
        const grid=document.getElementById('moduleGrid');
        grid.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
        if (target&&dragState.placeholder) {
            target.classList.add('drag-over');
            const mid=target.getBoundingClientRect().top+target.getBoundingClientRect().height/2;
            grid.insertBefore(dragState.placeholder, touch.clientY<mid?target:target.nextSibling);
        }
    }

    function onDragEnd() {
        if (!dragState) return; clearTimeout(dragState.timer);
        const card=dragState.el, grid=document.getElementById('moduleGrid');
        if (dragState.moved&&dragState.placeholder) {
            card.classList.remove('dragging'); card.style.position=''; card.style.width=''; card.style.left=''; card.style.top=''; card.style.zIndex='';
            grid.insertBefore(card,dragState.placeholder); dragState.placeholder.remove();
            grid.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
        }
        dragState=null;
    }

    // ====================================================================
    //  SHORTCUT PICKER
    // ====================================================================
    let tempShortcutSelection = [];

    function openShortcutPicker() {
        const available = ALL_SHORTCUTS.filter(s => s.roles.includes(currentUser.role));
        const defaultIds = DEFAULT_SHORTCUTS_BY_ROLE[currentUser.role] || [];
        const savedIds = loadShortcutIds() || defaultIds;
        tempShortcutSelection = [...savedIds];
        const list = document.getElementById('shortcutList'); list.innerHTML = '';
        available.forEach(item => {
            const sel = tempShortcutSelection.includes(item.id);
            const div = document.createElement('div');
            div.className = `modal-item ${sel?'selected':''}`;
            div.dataset.id = item.id;
            div.onclick = () => toggleShortcutItem(div, item.id);
            div.innerHTML = `<div class="modal-item-icon ${item.color}">${item.icon}</div><div class="modal-item-info"><div class="modal-item-name">${item.name}</div><div class="modal-item-desc">${item.desc}</div></div><div class="modal-item-check">${sel?'‚úì':''}</div>`;
            list.appendChild(div);
        });
        document.getElementById('shortcutModal').classList.add('show');
    }

    function toggleShortcutItem(div, id) {
        const idx = tempShortcutSelection.indexOf(id);
        if (idx > -1) { tempShortcutSelection.splice(idx,1); div.classList.remove('selected'); div.querySelector('.modal-item-check').textContent=''; }
        else { if(tempShortcutSelection.length>=4){showToast('‚ö†Ô∏è ÊúÄÂ§öÈÅ∏ 4 ÂÄãÂø´Êç∑');return;} tempShortcutSelection.push(id); div.classList.add('selected'); div.querySelector('.modal-item-check').textContent='‚úì'; }
    }

    function closeShortcutPicker() { document.getElementById('shortcutModal').classList.remove('show'); }
    function saveShortcuts() { saveShortcutIds(tempShortcutSelection); closeShortcutPicker(); renderUtilities(); showToast('‚úÖ Âø´Êç∑Â∑•ÂÖ∑Â∑≤Êõ¥Êñ∞'); }
    document.getElementById('shortcutModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeShortcutPicker(); });

    // ====================================================================
    //  NAVIGATION ‚Äî ÊîØÊè¥Ëá™Ë®ÇÂèÉÊï∏ + Â§ñÈÉ® URL
    // ====================================================================
    let currentModuleUrl = '';

    function navigateToModule(mod) {
        if (isEditMode) return;

        // Âü∫Êú¨ÂèÉÊï∏
        const baseParams = { uid:currentUser.lineUid, name:currentUser.name, role:currentUser.role, token:authToken, from:'portal' };

        // Ëá™Ë®ÇÂèÉÊï∏ÔºàÊõøÊèõ {name}, {uid}, {role}Ôºâ
        if (mod.customParams) {
            for (const [key, val] of Object.entries(mod.customParams)) {
                baseParams[key] = val.replace('{name}', currentUser.name).replace('{uid}', currentUser.lineUid).replace('{role}', currentUser.role);
            }
        }

        const params = new URLSearchParams(baseParams);

        // Â§ñÈÉ® URL vs Áõ∏Â∞çË∑ØÂæë
        let fullUrl;
        if (mod.url.startsWith('http')) {
            const sep = mod.url.includes('?') ? '&' : '?';
            fullUrl = `${mod.url}${sep}${params}`;
        } else {
            const base = CONFIG.BASE_URL.endsWith('/') ? CONFIG.BASE_URL : CONFIG.BASE_URL + '/';
            fullUrl = `${base}${mod.url}?${params}`;
        }

        currentModuleUrl = fullUrl;
        document.getElementById('moduleIcon').textContent = mod.icon;
        document.getElementById('moduleTitle').textContent = mod.name;
        const loading = document.getElementById('moduleLoading'); loading.classList.remove('hide');
        const frame = document.getElementById('moduleFrame');
        frame.onload = () => setTimeout(() => loading.classList.add('hide'), 200);
        frame.src = currentModuleUrl;
        document.querySelector('.header').style.display = 'none';
        document.querySelector('.main').style.display = 'none';
        document.getElementById('modulePage').style.display = 'flex';
    }

    function backToHome() {
        document.getElementById('moduleFrame').src = ''; currentModuleUrl = '';
        document.getElementById('modulePage').style.display = 'none';
        document.querySelector('.header').style.display = '';
        document.querySelector('.main').style.display = '';
    }

    function refreshModule() {
        if (!currentModuleUrl) return;
        const l = document.getElementById('moduleLoading'); l.classList.remove('hide');
        const f = document.getElementById('moduleFrame');
        f.onload = () => setTimeout(() => l.classList.add('hide'), 200);
        f.src = currentModuleUrl;
    }

    function openModuleNewTab() { if(currentModuleUrl) window.open(currentModuleUrl,'_blank'); }

    window.addEventListener('popstate', () => { if(document.getElementById('modulePage').style.display==='flex') backToHome(); });
    const _origNav = navigateToModule;
    navigateToModule = function(mod) { history.pushState({module:mod.id},'',`#${mod.id}`); _origNav(mod); };

    // ====================================================================
    //  DEVELOPING MODAL
    // ====================================================================
    function showDevModal() { document.getElementById('devModal').classList.add('show'); }
    function closeDevModal() { document.getElementById('devModal').classList.remove('show'); }
    document.getElementById('devModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeDevModal(); });

    // ====================================================================
    //  HELPERS
    // ====================================================================
    async function refreshData() { showToast('üîÑ Êõ¥Êñ∞‰∏≠...'); renderModules(); renderUtilities(); showToast('‚úÖ Â∑≤Êõ¥Êñ∞'); }
    function hasModuleAccess(mod) {
        if (!currentUser) return false;
        if (currentUser.role==='super_admin') return true;
        if (mod.roles?.includes(currentUser.role)) return true;
        if (currentUser.permissions.includes('all')||currentUser.permissions.includes(mod.permission)) return true;
        return false;
    }
    function setGreeting() { const h=new Date().getHours(); document.getElementById('greetingText').textContent = h<12?'Êó©ÂÆâ ‚òÄÔ∏è':h<18?'ÂçàÂÆâ üå§Ô∏è':'ÊôöÂÆâ üåô'; }
    function getRoleDisplay(r) { return {super_admin:'Ë∂ÖÁ¥öÁÆ°ÁêÜÂì°',admin:'ÁÆ°ÁêÜÂì°',staff:'Ë°åÊîø‰∫∫Âì°',coach:'ÊïôÁ∑¥',analyst:'ÂàÜÊûêÂ∏´'}[r]||r; }
    function updateLoadingText(t) { const e=document.querySelector('.loading-text'); if(e) e.textContent=t; }
    function hideLoading() { setTimeout(()=>document.getElementById('loadingScreen').classList.add('hide'),300); }
    function showLoginScreen() { document.getElementById('loadingScreen').classList.add('hide'); document.getElementById('loginScreen').classList.add('show'); }
    function showLoginError(m) { const e=document.getElementById('loginError'); e.textContent=m; e.classList.add('show'); }
    function showNoPermission() { document.getElementById('loadingScreen').classList.add('hide'); document.getElementById('mainApp').style.display='block'; document.querySelector('.main').innerHTML=`<div class="no-permission"><div class="no-permission-icon">üîí</div><div class="no-permission-title">Â∞öÊú™ÊéàÊ¨ä</div><div class="no-permission-desc">ÊÇ®ÁöÑÂ∏≥ËôüÂ∞öÊú™ÈñãÈÄöÁÆ°ÁêÜÂæåÂè∞Ê¨äÈôê„ÄÇ<br>Ë´ãËÅØÁπ´Ë∂ÖÁ¥öÁÆ°ÁêÜÂì°ÈÄ≤Ë°åÊéàÊ¨ä„ÄÇ</div></div>`; }
    function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
    </script>
</body>
</html>
